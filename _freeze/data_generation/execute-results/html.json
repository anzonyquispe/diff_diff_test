{
  "hash": "7bf8def836fafd76af4a593ee76096bb",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Synthetic Data Generation\"\n---\n\n\n\n\n# Data Generation Process\n\nWe generate synthetic panel data following the simulation design in Callaway & Sant'Anna (2021), with heterogeneous treatment effects that vary by:\n\n1. **Treatment cohort** (when units first receive treatment)\n2. **Time since treatment** (dynamic effects)\n\nThis design creates a challenging test case where traditional TWFE would produce biased estimates.\n\n## Data Generating Process\n\nThe outcome variable follows:\n\n$$Y_{it} = \\alpha_i + \\lambda_t + \\tau_{g,t} \\cdot D_{it} + \\varepsilon_{it}$$\n\nWhere:\n\n- $\\alpha_i$: Unit fixed effect\n- $\\lambda_t$: Time fixed effect\n- $D_{it}$: Treatment indicator (1 if unit $i$ is treated at time $t$)\n- $\\tau_{g,t}$: Treatment effect that varies by cohort $g$ and calendar time $t$\n- $\\varepsilon_{it} \\sim N(0, 1)$: Idiosyncratic error\n\n### Heterogeneous Treatment Effects\n\nWe specify treatment effects that:\n\n- **Increase with time since treatment** (dynamic effects)\n- **Vary by treatment cohort** (cohort heterogeneity)\n\n$$\\tau_{g,t} = \\tau_0 + \\delta_g + \\gamma \\cdot (t - g)$$\n\nWhere:\n\n- $\\tau_0 = 1.0$: Base treatment effect\n- $\\delta_g$: Cohort-specific shift (earlier cohorts have larger effects)\n- $\\gamma = 0.1$: Effect growth per period since treatment\n\n## R Implementation\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(20240115)\n\n# Parameters\nn_units <- 10000\nn_periods <- 10\nbase_year <- 2010\nyears <- base_year:(base_year + n_periods - 1)\n\n# Treatment cohorts and probabilities\ntreat_cohorts <- c(0, 2012, 2014, 2016, 2018)  # 0 = never treated\ncohort_probs <- c(0.30, 0.20, 0.20, 0.20, 0.10)\n\n# Cohort-specific effect shifts (earlier cohorts have larger effects)\ncohort_effects <- c(0, 0.5, 0.3, 0.1, 0.0)  # delta_g for each cohort\nnames(cohort_effects) <- treat_cohorts\n\n# Base effect and dynamic effect parameter\ntau_0 <- 1.0\ngamma <- 0.1  # Effect growth per period\n\ncat(\"Generating panel data...\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGenerating panel data...\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Units:\", format(n_units, big.mark = \",\"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nUnits: 10,000 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Periods:\", n_periods, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPeriods: 10 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Total observations:\", format(n_units * n_periods, big.mark = \",\"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTotal observations: 1e+05 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Generate unit-level data\nunit_data <- data.frame(\n  id = 1:n_units,\n  g = sample(treat_cohorts, n_units, replace = TRUE, prob = cohort_probs),\n  unit_fe = rnorm(n_units, 0, 1)\n)\n\n# Time fixed effects\ntime_fe_vals <- seq(-0.2, 0.2, length.out = n_periods)\nnames(time_fe_vals) <- years\n\n# Expand to panel\ncat(\"Creating panel structure...\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCreating panel structure...\n```\n\n\n:::\n\n```{.r .cell-code}\npanel <- expand.grid(id = 1:n_units, year = years)\npanel <- merge(panel, unit_data, by = \"id\")\n\n# Add time fixed effects\npanel$time_fe <- time_fe_vals[as.character(panel$year)]\n\n# Treatment indicator\npanel$treated <- (panel$g > 0) & (panel$year >= panel$g)\n\n# Calculate heterogeneous treatment effects\n# tau_gt = tau_0 + delta_g + gamma * (t - g) for treated observations\npanel$tau_gt <- 0\ntreated_idx <- panel$treated\npanel$tau_gt[treated_idx] <- tau_0 +\n  cohort_effects[as.character(panel$g[treated_idx])] +\n  gamma * (panel$year[treated_idx] - panel$g[treated_idx])\n\n# Generate outcome\npanel$y <- 2 + panel$unit_fe + panel$time_fe +\n           panel$tau_gt * as.integer(panel$treated) +\n           rnorm(nrow(panel), 0, 1)\n\n# Rename for standard DiD notation\npanel$first_treat <- panel$g\n\n# Sort for efficiency\npanel <- panel[order(panel$id, panel$year), ]\n\ncat(\"\\nData generation complete!\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nData generation complete!\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Treatment group distribution:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTreatment group distribution:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(table(unit_data$g))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n   0 2012 2014 2016 2018 \n2991 2018 1928 2046 1017 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Save for use in subsequent chapters\nsaveRDS(panel, \"sim_data.rds\")\nwrite.csv(panel[, c(\"id\", \"year\", \"y\", \"first_treat\", \"treated\")],\n          \"sim_data.csv\", row.names = FALSE)\n```\n:::\n\n\n\n\n## True Treatment Effects\n\nLet's calculate and display the true treatment effects for validation:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'dplyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n\n\n:::\n\n```{.r .cell-code}\n# Calculate true ATT by cohort and event time\ntrue_effects <- panel %>%\n  filter(treated) %>%\n  mutate(event_time = year - g) %>%\n  group_by(g, event_time) %>%\n  summarise(\n    true_att = mean(tau_gt),\n    n_obs = n(),\n    .groups = \"drop\"\n  )\n\n# Overall ATT\noverall_att <- mean(panel$tau_gt[panel$treated])\ncat(\"Overall true ATT:\", round(overall_att, 4), \"\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nOverall true ATT: 1.5869 \n```\n\n\n:::\n\n```{.r .cell-code}\n# ATT by cohort\ncat(\"True ATT by cohort:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTrue ATT by cohort:\n```\n\n\n:::\n\n```{.r .cell-code}\ncohort_att <- true_effects %>%\n  group_by(g) %>%\n  summarise(true_att = mean(true_att), .groups = \"drop\")\nprint(cohort_att)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 2\n      g true_att\n  <dbl>    <dbl>\n1  2012     1.85\n2  2014     1.55\n3  2016     1.25\n4  2018     1.05\n```\n\n\n:::\n\n```{.r .cell-code}\n# Dynamic effects (event study)\ncat(\"\\nTrue dynamic effects (averaged across cohorts):\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nTrue dynamic effects (averaged across cohorts):\n```\n\n\n:::\n\n```{.r .cell-code}\ndynamic_effects <- true_effects %>%\n  group_by(event_time) %>%\n  summarise(true_att = weighted.mean(true_att, n_obs), .groups = \"drop\")\nprint(dynamic_effects)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 8 × 2\n  event_time true_att\n       <dbl>    <dbl>\n1          0     1.26\n2          1     1.36\n3          2     1.50\n4          3     1.60\n5          4     1.80\n6          5     1.90\n7          6     2.1 \n8          7     2.2 \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\n\nggplot(dynamic_effects, aes(x = event_time, y = true_att)) +\n  geom_point(size = 3) +\n  geom_line() +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"gray50\") +\n  geom_vline(xintercept = -0.5, linetype = \"dashed\", color = \"red\") +\n  labs(\n    x = \"Event Time (periods since treatment)\",\n    y = \"True ATT\",\n    title = \"True Dynamic Treatment Effects\"\n  ) +\n  theme_minimal() +\n  scale_x_continuous(breaks = -7:7)\n```\n\n::: {.cell-output-display}\n![True treatment effects by event time](data_generation_files/figure-html/plot-true-effects-1.png){width=672}\n:::\n:::\n\n\n\n\n## Python Implementation\n\nFor Python packages, we'll load the same data:\n\n\n\n\n::: {.cell}\n\n```{.python .cell-code}\nimport numpy as np\nimport pandas as pd\n\n# Load the data generated by R for consistency\ndf = pd.read_csv(\"sim_data.csv\")\nprint(f\"Loaded {len(df):,} observations\")\nprint(f\"Units: {df['id'].nunique():,}\")\nprint(f\"Periods: {df['year'].nunique()}\")\nprint(f\"\\nTreatment cohort distribution:\")\nprint(df.groupby('first_treat')['id'].nunique())\n```\n:::\n\n\n\n\n## Data Summary\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"Final dataset dimensions:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFinal dataset dimensions:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Rows:\", format(nrow(panel), big.mark = \",\"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 10,000,000 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Columns:\", ncol(panel), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nColumns: 9 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nColumn names:\", paste(names(panel), collapse = \", \"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nColumn names: id, year, g, unit_fe, time_fe, treated, tau_gt, y, first_treat \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nTreatment status:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nTreatment status:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Treated observations:\", format(sum(panel$treated), big.mark = \",\"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTreated observations: 3,802,782 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Control observations:\", format(sum(!panel$treated), big.mark = \",\"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nControl observations: 6,197,218 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nMemory usage:\", format(object.size(panel), units = \"MB\"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nMemory usage: 610.4 Mb \n```\n\n\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}